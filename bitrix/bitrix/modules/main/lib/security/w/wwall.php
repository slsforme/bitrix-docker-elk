<? namespace Bitrix\Main\Security\W;$GLOBALS['____1464299107']= array(base64_decode('d'.'GltZQ='.'='),base64_decode('dG'.'l'.'tZQ=='),base64_decode(''.'an'.'N'.'vb'.'l9kZWNvZGU='),base64_decode('YXJ'.'yYX'.'lfbWVyZ2U='),base64_decode(''.'am9'.'pb'.'g'.'=='),base64_decode('am9p'.'bg=='),base64_decode('a'.'m9p'.'bg=='),base64_decode(''.'YXJyYXl'.'fcG9w'),base64_decode('YXJyYXlfc2hpZnQ'.'='),base64_decode('YX'.'J'.'y'.'YXlfc'.'2h'.'pZn'.'Q'.'='),base64_decode('YX'.'J'.'yY'.'Xl'.'fc'.'2hpZnQ'.'='),base64_decode('YXJyY'.'Xlfc2hpZnQ'.'='),base64_decode('Y'.'X'.'J'.'yYXl'.'fbWVyZ2'.'U'.'='),base64_decode(''.'aXNfY'.'XJyY'.'Xk='),base64_decode('Y'.'X'.'JyYXlfbWVyZ2U='),base64_decode('a'.'W5f'.'YXJyYXk='),base64_decode('aW'.'5'.'fYXJyYX'.'k='),base64_decode('a'.'W5fYXJyYXk='),base64_decode(''.'aW5fYXJ'.'yY'.'Xk='),base64_decode(''.'aW5fYX'.'JyYXk='),base64_decode('dGltZQ=='),base64_decode(''.'dGltZQ=='),base64_decode('YXJy'.'Y'.'XlfbW'.'Fw'),base64_decode('Z2V0'.'X2x'.'v'.'YWRl'.'ZF9leHR'.'lbnNpb25z'),base64_decode('anNv'.'bl9lbmNvZ'.'G'.'U='),base64_decode('a'.'nNvbl9lbmNv'.'ZGU'.'='),base64_decode('cGhwd'.'mVyc2'.'lvb'.'g=='),base64_decode(''.'anNvbl9lb'.'m'.'N'.'vZ'.'GU'.'='),base64_decode('a'.'m'.'9pbg=='));if(!function_exists(__NAMESPACE__.'\\___1866788889')){function ___1866788889($_1222411604){static $_1285601476= false; if($_1285601476 == false) $_1285601476=array(''.'V1dB'.'TExfTE9DSw==','c2Vjd'.'X'.'JpdH'.'k=','REFU'.'QQ==','e'.'yI=',''.'V1dB'.'T'.'Ex'.'f'.'TE9DSw==','c2VjdX'.'JpdHk=','U0VD'.'VVJJVFlfV1d'.'BTE'.'x'.'fR'.'VhDRVBUSU9O','R'.'kF'.'JT'.'F9DSEVDS0lORw==','Q2FuIG5v'.'dCBleGVjdXRlIHd3Y'.'WxsIHJ1bGV'.'zOiA=','I'.'F'.'RyYW'.'Nl'.'O'.'iA=','UkV'.'RVUVTV'.'F9VUkk=','a2'.'V5cw==','dm'.'F'.'sdWVz','U0'.'VDVVJ'.'J'.'VFlfV1dBTE'.'x'.'fT'.'U9ESUZZ',''.'Lg==','U0V'.'DV'.'VJJV'.'Flf'.'V1dB'.'TExfVU5'.'T'.'RVQ=','Lg'.'==','U0VDVVJJVFlfV1d'.'BTEx'.'fR'.'VhJV'.'A='.'=','Lg==','Z2xvYmFs','a2V5cw==','dmFsdWVz','Z2'.'V0','Z2V'.'0','cG9z'.'dA==','cG9zdA'.'==','Y29v'.'a2ll','Y2'.'9v'.'a'.'2ll','cmVxdWVzd'.'A==','cmVxdWVzd'.'A==','Z2xvYmFs','Z2xvYmFs','b'.'WFpbl9z'.'ZWM=',''.'V1dBTExfQUN'.'UVUF'.'MSVpFX'.'1JVTEVT',''.'dg==','dmV'.'yc2'.'lv'.'bg==','aQ==','aXN'.'Jb'.'n'.'N0YW'.'xsZW'.'Q=',''.'dg='.'=',''.'aW5p','b'.'W9kdW'.'x'.'lcw='.'=','bGljZW'.'5'.'zZQ==',''.'cGhw','dg==',''.'ZX'.'h0','c2Vjd'.'XJpdHk=',''.'ZGI=','dHlw'.'ZQ'.'==','ZG'.'I=','dmVyc2l'.'v'.'b'.'g==','ZGI'.'=',''.'dH'.'l'.'wZ'.'Q==','Z'.'GI=','d'.'HlwZQ='.'=','d'.'m'.'Vyc2l'.'vbg='.'=','ZGI=','dm'.'Vyc2lv'.'bg'.'==','ZW5'.'2aXJv'.'bm1lbnQ'.'=','dm'.'1fdm'.'Vy'.'c2lv'.'bg='.'=',''.'dm0=','d'.'g'.'==',''.'ZW'.'52aXJvbm1lbn'.'Q=','dm1'.'fdmV'.'y'.'c2'.'l'.'vbg==','c29j'.'a2V0VGltZW91dA==',''.'c'.'3RyZW'.'FtVGltZ'.'W'.'9'.'1'.'d'.'A==','KCc=','ZGF0YQ==','J'.'ywgJw==','bW'.'9'.'kd'.'Wxl',''.'JywgJw='.'=',''.'bW9kdWxl'.'X'.'3ZlcnNpb24=','Jy'.'k=','LCA'.'=','U0VDVV'.'JJ'.'V'.'F'.'lfV1d'.'B'.'TExfRVhDRVB'.'USU9O',''.'b'.'WFp'.'b'.'g==','RkFJ'.'TF9SRUZSRV'.'NISU5'.'H','Q2F'.'u'.'IG5vdC'.'ByZWZyZXN'.'oIH'.'d3'.'YWxsIHJ1bG'.'VzOiA'.'=','IFRyYWNlO'.'i'.'A'.'=','ZGF0'.'YQ==','e'.'yI=','LS'.'0tLS1'.'CRUd'.'JTiBQVUJMSU'.'MgS0VZLS0tLS0=','Ck'.'1'.'J'.'SUJJakFO'.'Qm'.'d'.'rcWh'.'r'.'aUc5dzBC'.'QV'.'FFR'.'kFBT'.'0NBUThBT'.'U'.'l'.'JQkNnS0N'.'BUUVB'.'cThR'.'R'.'TBIam1ISlV'.'TdFdWNm'.'4wemEKUlZvTHgwMkt'.'6YmZ'.'y'.'YlMvUD'.'ZzV'.'2'.'F'.'4VHp3OFNlR1R0YlRDT3JwSGk'.'1U'.'UY2'.'T1J5alovWHh6L0'.'tMVTFHYm9mOUNaMw'.'o0ej'.'dT'.'a3FVdDY'.'2aWJYdk'.'9GQn'.'g'.'0Zncv'.'QVBQUk'.'dEcXR'.'t'.'M'.'G5EM2'.'Z'.'nR3'.'N1M1JlUG'.'d3MjlpOCt2bTd'.'tdEJLSlVZb'.'DRyClZ'.'wYj'.'ZzZlpFVDlLR'.'WI2V'.'DFIRFl'.'tRXZjMWhx'.'L2lpdXl4THJ'.'aW'.'mk1UTZ'.'VZmY0VUV2VE'.'krNjhzc0ZS'.'a1Erb3dU'.'Un'.'kK'.'ZU'.'9JTWJGaE0vVVR'.'tZlZZYlR'.'SRnk'.'yb'.'1VROFdNe'.'mEy'.'bko'.'1U2FoemkxVUtPMWp'.'B'.'a'.'l'.'hU'.'U'.'FJy'.'e'.'mM3QWp1NjM5ajFP'.'M'.'ApwcHFm'.'bTV4Z1ds'.'R'.'kFK'.'a'.'0hRVGdiZGQ1QVdxREZRa3Q5S'.'E'.'trWS'.'t'.'UbmZCT'.'EdWTXZW'.'eVB3VEhO'.'V1FZQ'.'X'.'c0e'.'HBn'.'L3d'.'BClp3'.'SUR'.'BUUFCCi0tLS0t'.'RU5EI'.'FBVQk'.'xJQyBLRVk'.'tLS0tLQ==');return base64_decode($_1285601476[$_1222411604]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_592266058= 'https://wwall.bitrix.info/rules.php'; protected $_1209251568= true; public function handle(){ try{  $_681266997= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_681266997)){ return;}  $_1368885803= Cache::createInstance(); $_2075917366= false; if($_1368885803->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1943165277= $_1368885803->getVars(); if($GLOBALS['____1464299107'][0]()- $_1943165277> round(0+10+10)){  $_367315548= Application::getConnection(); $_2092728688= RuleRecordTable::getTableName(); $_367315548->truncateTable($_2092728688); RuleRecordTable::cleanCache(); $_1368885803->clean(___1866788889(0), ___1866788889(1));}} elseif($_1368885803->startDataCache()){  $_1368885803->endDataCache($GLOBALS['____1464299107'][1]()); $_2075917366= true;} foreach($_681266997 as $_1447382107){ $_1114250294= new PublicKeyCipher; $_1618877987= $_1114250294->decrypt($_1447382107[___1866788889(2)], static::__821325502()); if(!str_starts_with($_1618877987, ___1866788889(3))){ continue;} $_1543040609= $GLOBALS['____1464299107'][2]($_1618877987, true); if(!empty($_1543040609)){ $_1354304282= Rule::make($_1543040609); $_1190651587= $this->handleRule($_1354304282); $this->applyHandlingResults($_1190651587);}}  if($_2075917366){ $_1368885803->clean(___1866788889(4), ___1866788889(5));}} catch(\Throwable $_888263180){ $this->logEvent( ___1866788889(6), ___1866788889(7), ___1866788889(8). $_888263180->getMessage(). ___1866788889(9). $_888263180->getTraceAsString());}}  public function handleRule(Rule $_1354304282): array{ $_1190651587=[]; if($_1354304282->matchPath($_SERVER[___1866788889(10)])){  $_585406543= $this->getContextElements($_1354304282->getContext()); foreach($_585406543 as $_1994123866 => &$_223735400){ $_1190651587= $GLOBALS['____1464299107'][3]($_1190651587, $this->recursiveContextKeyHandle($_1994123866, $_223735400,[], $_1354304282));}} return $_1190651587;}  public function applyHandlingResults(array $_1190651587){ $_585406543= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1190651587 as $_1885397765){ $_223735400=& $_585406543[$_1885397765->getContextName()]; $_1915361039= $_1885397765->getRuleResult(); $_1354304282= $_1885397765->getRule(); if($_1915361039 instanceof ModifyResult){ if($_1354304282->getProcess() === ___1866788889(11)){  static::rewriteContextKey( $_1885397765->getContextName(), $_223735400, $_1885397765->getContextKey(), $_1915361039->getCleanValue());} elseif($_1354304282->getProcess() === ___1866788889(12)){ static::rewriteContextValue( $_1885397765->getContextName(), $_223735400, $_1885397765->getContextKey(), $_1915361039->getCleanValue());} $this->logEvent( ___1866788889(13), $_1885397765->getContextName(), $GLOBALS['____1464299107'][4](___1866788889(14), $_1885397765->getContextKey()));} elseif($_1915361039 instanceof CheckResult &&!$_1915361039->isSuccess()){ if($_1915361039->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1885397765->getContextName(), $_223735400, $_1885397765->getContextKey(),); $this->logEvent( ___1866788889(15), $_1885397765->getContextName(), $GLOBALS['____1464299107'][5](___1866788889(16), $_1885397765->getContextKey()));} elseif($_1915361039->getAction() === RuleAction::EXIT){ $this->logEvent( ___1866788889(17), $_1885397765->getContextName(), $GLOBALS['____1464299107'][6](___1866788889(18), $_1885397765->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1209251568= false;} protected function rewriteContextKey($_1994123866, &$_223735400, $_1675973472, $_971279241){ $_1816422126= $_1675973472;  $GLOBALS['____1464299107'][7]($_1816422126); $_1816422126[]= $_971279241; if($_1994123866 === ___1866788889(19)){ $_886738821= $GLOBALS['____1464299107'][8]($_1675973472); $GLOBALS['____1464299107'][9]($_1816422126); if(empty($_1675973472)){ $GLOBALS[$_971279241]= $GLOBALS[$_886738821]; unset($GLOBALS[$_886738821]);} else{ $_223735400=& $GLOBALS[$_886738821]; $_854955557= ArrayHelper::getByNestedKey($_223735400, $_1675973472);  ArrayHelper::setByNestedKey($_223735400, $_1816422126, $_854955557);  ArrayHelper::unsetByNestedKey($_223735400, $_1675973472);}} else{ $_854955557= ArrayHelper::getByNestedKey($_223735400, $_1675973472);  ArrayHelper::setByNestedKey($_223735400, $_1816422126, $_854955557);  ArrayHelper::unsetByNestedKey($_223735400, $_1675973472);}} protected function rewriteContextValue($_1994123866, &$_223735400, $_975067175, $_854955557){ if($_1994123866 === 'global'){ $_886738821= $GLOBALS['____1464299107'][10]($_975067175); if(empty($_975067175)){ $GLOBALS[$_886738821]= $_854955557;} else{ $_223735400=& $GLOBALS[$_886738821]; ArrayHelper::setByNestedKey($_223735400, $_975067175, $_854955557);}} else{  ArrayHelper::setByNestedKey($_223735400, $_975067175, $_854955557);}} protected function unsetContextValue($_1994123866, &$_223735400, $_975067175){ if($_1994123866 === 'global'){ $_886738821= $GLOBALS['____1464299107'][11]($_975067175); if(empty($_975067175)){ unset($GLOBALS[$_886738821]);} else{ $_223735400=& $GLOBALS[$_886738821]; ArrayHelper::unsetByNestedKey($_223735400, $_975067175);}} else{ ArrayHelper::unsetByNestedKey($_223735400, $_975067175);}}  protected function recursiveContextKeyHandle(string $_1994123866, array &$_223735400, array $_1342219231, Rule $_1354304282): array{  $_1190651587=[]; foreach($_223735400 as $_148762620 => $_854955557){ $_975067175= $GLOBALS['____1464299107'][12]($_1342219231,[$_148762620]); if($_1354304282->matchKey($_975067175)){  if($_1354304282->getProcess() === ___1866788889(20)){ $_1915361039= $_1354304282->evaluate($_148762620);} elseif($_1354304282->getProcess() === ___1866788889(21)){ $_1915361039= $_1354304282->evaluateValue($_854955557);}  if(!empty($_1915361039) && $_1915361039 instanceof RuleResult){ $_1190651587[]= new HandlingResult($_1994123866, $_975067175, $_1915361039, $_1354304282);}}  if($GLOBALS['____1464299107'][13]($_854955557)){ $_1190651587= $GLOBALS['____1464299107'][14]($_1190651587, $this->recursiveContextKeyHandle( $_1994123866, $_223735400[$_148762620], $_975067175, $_1354304282));}} return $_1190651587;} protected function getContextElements(array $_713376006){ $_836871234=[]; if($GLOBALS['____1464299107'][15](___1866788889(22), $_713376006, true)){ $_836871234[___1866788889(23)]= &$_GET;} if($GLOBALS['____1464299107'][16](___1866788889(24), $_713376006, true)){ $_836871234[___1866788889(25)]= &$_POST;} if($GLOBALS['____1464299107'][17](___1866788889(26), $_713376006, true)){ $_836871234[___1866788889(27)]= &$_COOKIE;} if($GLOBALS['____1464299107'][18](___1866788889(28), $_713376006, true)){ $_836871234[___1866788889(29)]= &$_REQUEST;} if($GLOBALS['____1464299107'][19](___1866788889(30), $_713376006, true)){ $_836871234[___1866788889(31)]= $GLOBALS;} return $_836871234;} public static function refreshRules(){ try{ $_747497859= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1464299107'][20]()- $_747497859)< static::CACHE_RULES_TTL){ return;} Option::set(___1866788889(32), ___1866788889(33), $GLOBALS['____1464299107'][21]()); $_242564106= null;  $_717006483= $GLOBALS['____1464299107'][22](function($_1408681651){ return[___1866788889(34) => $_1408681651[___1866788889(35)], ___1866788889(36) => (int) $_1408681651[___1866788889(37)]];}, ModuleManager::getModulesFromDisk());  $_1950125601=[]; foreach($GLOBALS['____1464299107'][23]() as $_1851576071){ $_142712689= new ReflectionExtension($_1851576071); $_1950125601[$_1851576071]=[ ___1866788889(38) => $_142712689->getVersion(), ___1866788889(39) => $_142712689->getINIEntries()];} $_414867415=[ ___1866788889(40) => $GLOBALS['____1464299107'][24]($_717006483), ___1866788889(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1866788889(42) => $GLOBALS['____1464299107'][25]([ ___1866788889(43) => $GLOBALS['____1464299107'][26](), ___1866788889(44) => $_1950125601])]; if(Loader::includeModule(___1866788889(45))){ $_595927311= CSecuritySystemInformation::getSystemInformation(); if(isset($_595927311[___1866788889(46)][___1866788889(47)]) && isset($_595927311[___1866788889(48)][___1866788889(49)])){ $_414867415[___1866788889(50)]=[ ___1866788889(51) => $_595927311[___1866788889(52)][___1866788889(53)], ___1866788889(54) => $_595927311[___1866788889(55)][___1866788889(56)]];} if(isset($_595927311[___1866788889(57)][___1866788889(58)])){ $_414867415[___1866788889(59)]=[___1866788889(60) => $_595927311[___1866788889(61)][___1866788889(62)]];}}  $_1074793060= new HttpClient([ ___1866788889(63) => round(0+1.25+1.25+1.25+1.25), ___1866788889(64) => round(0+2.5+2.5)]); $_229164126= $_1074793060->post( static::$_592266058, $_414867415); if($_1074793060->getStatus() == round(0+40+40+40+40+40) &&!empty($_229164126)){ $_242564106= Json::decode($_229164126);}  if($_242564106 !== null){ $_367315548= Application::getConnection(); $_2092728688= RuleRecordTable::getTableName(); if(!empty($_242564106)){ foreach($_242564106 as $_1929933505){ if(!static::checkRuleSign($_1929933505)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1464299107'][27]($_1929933505));}}}  $_367315548->truncateTable($_2092728688);  if(!empty($_242564106)){ $_488294107=[]; foreach($_242564106 as $_1929933505){ $_488294107[]= ___1866788889(65). $_367315548->getSqlHelper()->forSql($_1929933505[___1866788889(66)]). ___1866788889(67). $_367315548->getSqlHelper()->forSql($_1929933505[___1866788889(68)]). ___1866788889(69). $_367315548->getSqlHelper()->forSql($_1929933505[___1866788889(70)]). ___1866788889(71);} $_1224037072= $GLOBALS['____1464299107'][28](___1866788889(72), $_488294107);  $_367315548->query("INSERT INTO {$_2092728688} (DATA, MODULE, MODULE_VERSION) VALUES {$_1224037072}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_888263180){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1866788889(73), ___1866788889(74), ___1866788889(75), ___1866788889(76). $_888263180->getMessage(). ___1866788889(77). $_888263180->getTraceAsString());}} protected static function checkRuleSign($_1354304282){ $_1114250294= new PublicKeyCipher; $_1543040609= $_1114250294->decrypt($_1354304282[___1866788889(78)], static::__821325502()); return str_starts_with($_1543040609, ___1866788889(79));} private static function __821325502(){ $_1188697049= ''; $_1188697049 .= ___1866788889(80); $_1188697049 .= ___1866788889(81); return $_1188697049;} protected function logEvent($_359578517, $_1621550004, $_2069011692){ if($this->_1209251568){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_359578517, 'main', $_1621550004, $_2069011692);}}}?>